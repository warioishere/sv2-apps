services:
  # Bitcoin Core Manager - Secure API for managing Bitcoin Core containers
  bc-manager:
    build:
      context: ./bc-manager
      dockerfile: Dockerfile
    container_name: sv2-bc-manager
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Only this container has Docker access
      - ../../..:/repo:ro  # Read-only access to docker-compose.yml
    networks:
      - default
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5001/health')"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  bitcoin-core-mainnet:
    build:
      context: ./bitcoin-core-ipc
      dockerfile: Dockerfile
    image: sv2-bitcoin-core-ipc:30.2
    container_name: sv2-bitcoin-mainnet
    profiles: ["bitcoin-mainnet"]
    volumes:
      - bitcoin-mainnet-data:/home/bitcoin/.bitcoin
      - bitcoin-mainnet-ipc:/home/bitcoin/.bitcoin/ipc
    environment:
      - NETWORK=mainnet
      - RPC_USER=stratum
      - RPC_PASSWORD=stratum123
    ports:
      - "8332:8332"   # mainnet RPC
      - "8333:8333"   # mainnet P2P
      - "28332:28332" # ZMQ
    restart: unless-stopped
    networks:
      - default
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-rpcuser=stratum", "-rpcpassword=stratum123", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  bitcoin-core-testnet:
    build:
      context: ./bitcoin-core-ipc
      dockerfile: Dockerfile
    image: sv2-bitcoin-core-ipc:30.2
    container_name: sv2-bitcoin-testnet
    profiles: ["bitcoin-testnet"]
    volumes:
      - bitcoin-testnet-data:/home/bitcoin/.bitcoin
      - bitcoin-testnet-ipc:/home/bitcoin/.bitcoin/ipc
    environment:
      - NETWORK=testnet4
      - RPC_USER=stratum
      - RPC_PASSWORD=stratum123
    ports:
      - "48332:48332"  # testnet4 RPC
      - "48333:48333"  # testnet4 P2P
      - "28333:28333"  # ZMQ
    restart: unless-stopped
    networks:
      - default
    healthcheck:
      test: ["CMD", "bitcoin-cli", "-chain=testnet4", "-rpcuser=stratum", "-rpcpassword=stratum123", "getblockchaininfo"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  jd-gui:
    build:
      context: ../../..  # sv2-apps root (relative path)
      dockerfile: miner-apps/jd-client/jd-gui/backend/Dockerfile
      args:
        SV2_TP_COMMIT: ${SV2_TP_COMMIT:-f4dfc9ed004cb455e3f5e99f4b533e583b3d3dd3}
    container_name: sv2-jd-gui
    ports:
      - "3000:5000"
    volumes:
      - jdc-config:/app/config
      - jdc-logs:/app/logs
      - jdc-data:/app/data
      - jdc-backups:/app/backups
      - sv2-tp-config:/app/config/sv2-tp
      - sv2-tp-logs:/app/logs/sv2-tp
      - bitcoin-mainnet-ipc:/bitcoin-ipc-mainnet:ro  # IPC socket for sv2-tp
      - bitcoin-testnet-ipc:/bitcoin-ipc-testnet:ro  # IPC socket for sv2-tp
      - ${HOME}/.bitcoin:/host-bitcoin:ro  # Mount host Bitcoin Core (if exists)
      - ../../..:/repo  # Mount sv2-apps root at /repo
    environment:
      - NODE_ENV=production
      - PORT=5000
      - LOG_LEVEL=info
      - SV2_APPS_PATH=/repo
      - BITCOIN_MAINNET_IPC=/bitcoin-ipc-mainnet/node.sock
      - BITCOIN_TESTNET_IPC=/bitcoin-ipc-testnet/node.sock
      - BITCOIN_RPC_USER=stratum
      - BITCOIN_RPC_PASSWORD=stratum123
    restart: unless-stopped
    networks:
      - default
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  bitcoin-mainnet-data:
    driver: local
  bitcoin-mainnet-ipc:
    driver: local
  bitcoin-testnet-data:
    driver: local
  bitcoin-testnet-ipc:
    driver: local
  jdc-config:
    driver: local
  jdc-logs:
    driver: local
  jdc-data:
    driver: local
  jdc-backups:
    driver: local
  sv2-tp-config:
    driver: local
  sv2-tp-logs:
    driver: local
